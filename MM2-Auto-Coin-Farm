local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
   Name = "FRXCTURED'S MM2",
   LoadingTitle = "FrxcturedMM2 Suite",
   LoadingSubtitle = "by Gemini",
   ConfigurationSaving = { Enabled = false },
   KeySystem = false
})

-- STATE
getgenv().Config = {
    Farm = false,
    ESP = true,
    GunESP = true,
    AutoHide = true,
    SubtleESP = true,
    Speed = 55,
    SafetyDist = 18,
    HideDepth = -50
}

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")
local playerRoles, collectedCoins, isHiding, isInRound = {}, {}, false, false
local collectedCount, currentMax, lastHrpPos, bodyVelocity = 0, 50, hrp.Position, nil

-- TABS
local MainTab = Window:CreateTab("Farming", 4483362458)
local VisualsTab = Window:CreateTab("Visuals", 4483345998)

-- ELEMENTS
MainTab:CreateToggle({
   Name = "Coin Farm",
   CurrentValue = false,
   Callback = function(Value) getgenv().Config.Farm = Value end,
})

MainTab:CreateSlider({
   Name = "Farm Speed",
   Range = {30, 100},
   Increment = 1,
   Suffix = "Speed",
   CurrentValue = 55,
   Callback = function(Value) getgenv().Config.Speed = Value end,
})

MainTab:CreateToggle({
   Name = "Auto Hide (Underground)",
   CurrentValue = true,
   Callback = function(Value) getgenv().Config.AutoHide = Value end,
})

VisualsTab:CreateToggle({
   Name = "Player Role ESP",
   CurrentValue = true,
   Callback = function(Value) getgenv().Config.ESP = Value end,
})

--- ### 1. THE NOCLIP ENGINE (WALL FIX) ### ---
-- This must run every frame to prevent physics from pushing you back
RunService.Stepped:Connect(function()
    if getgenv().Config.Farm and character then
        for _, part in ipairs(character:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = false
            end
        end
    end
end)

--- ### 2. CORE LOGIC ### ---

local function clearHighlights()
    for _, p in pairs(Players:GetPlayers()) do
        if p.Character and p.Character:FindFirstChild("RoleHighlight") then p.Character.RoleHighlight:Destroy() end
    end
end

local function applyHighlights()
    if not getgenv().Config.ESP then clearHighlights() return end
    local amIMurderer = (playerRoles[player.Name] and playerRoles[player.Name].Role == "Murderer")
    for name, data in pairs(playerRoles) do
        if name == player.Name then continue end
        local targetPlayer = Players:FindFirstChild(name)
        if targetPlayer and targetPlayer.Character then
            local hl = targetPlayer.Character:FindFirstChild("RoleHighlight") or Instance.new("Highlight", targetPlayer.Character)
            hl.Name = "RoleHighlight"
            if data.Role == "Murderer" then hl.FillColor = Color3.fromRGB(255,0,0) hl.FillTransparency = 0.5
            elseif data.Role == "Sheriff" or data.Role == "Hero" then hl.FillColor = Color3.fromRGB(0,120,255) hl.FillTransparency = 0.5
            elseif amIMurderer and getgenv().Config.SubtleESP then hl.FillTransparency = 1 hl.OutlineColor = Color3.white hl.OutlineTransparency = 0.6
            else if not amIMurderer then hl:Destroy() end end
        end
    end
end

local GameplayRemotes = game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("Gameplay")
GameplayRemotes.RoundStart.OnClientEvent:Connect(function(_, roles) playerRoles = roles isInRound = true applyHighlights() end)
GameplayRemotes.RoundEndFade.OnClientEvent:Connect(function() playerRoles = {} isInRound = false isHiding = false clearHighlights() end)
GameplayRemotes.CoinCollected.OnClientEvent:Connect(function(_, cur, max) collectedCount = tonumber(cur) or 0 currentMax = tonumber(max) or 50 end)

local function getMurderer()
    for name, data in pairs(playerRoles) do
        if data.Role == "Murderer" and name ~= player.Name then
            local p = Players:FindFirstChild(name)
            if p and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then return p.Character.HumanoidRootPart end
        end
    end
    return nil
end

task.spawn(function()
    while true do
        character = player.Character
        hrp = character and character:FindFirstChild("HumanoidRootPart")
        
        if getgenv().Config.Farm and isInRound and hrp then
            local mHrp = getMurderer()
            local dist = mHrp and (mHrp.Position - hrp.Position).Magnitude or math.huge
            
            -- Auto-Hide
            if getgenv().Config.AutoHide and dist < getgenv().Config.SafetyDist then
                if not isHiding then lastHrpPos = hrp.Position isHiding = true end
                hrp.CFrame = CFrame.new(hrp.Position.X, getgenv().Config.HideDepth, hrp.Position.Z)
                task.wait(0.5) continue
            elseif isHiding then 
                isHiding = false 
                hrp.CFrame = CFrame.new(hrp.Position.X, lastHrpPos.Y + 2, hrp.Position.Z) 
            end

            -- Reset/Full Bag
            if collectedCount >= currentMax and currentMax > 0 then
                if character:FindFirstChild("Humanoid") then character.Humanoid.Health = 0 end
                isInRound = false task.wait(5) continue
            end

            -- BodyVelocity Management
            if not bodyVelocity or bodyVelocity.Parent ~= hrp then
                if bodyVelocity then bodyVelocity:Destroy() end
                bodyVelocity = Instance.new("BodyVelocity", hrp)
                bodyVelocity.MaxForce = Vector3.new(9e9, 9e9, 9e9)
                if character:FindFirstChild("Humanoid") then character.Humanoid.PlatformStand = true end
            end

            local target, shortest = nil, math.huge
            for _, v in pairs(workspace:GetDescendants()) do
                if v.Name == "Coin_Server" and not collectedCoins[v] then
                    local d = (v.Position - hrp.Position).Magnitude
                    if d < shortest then shortest = d target = v end
                end
            end

            if target then
                task.wait(0.1)
                while getgenv().Config.Farm and target and target.Parent and (target.Position-hrp.Position).Magnitude > 0.5 do
                    if isHiding or not isInRound then break end
                    bodyVelocity.Velocity = (target.Position - hrp.Position).Unit * getgenv().Config.Speed
                    RunService.Heartbeat:Wait()
                end
                if bodyVelocity then bodyVelocity.Velocity = Vector3.zero end
                collectedCoins[target] = true
            end
        else
            if bodyVelocity then bodyVelocity:Destroy() bodyVelocity = nil end
            if character and character:FindFirstChild("Humanoid") then character.Humanoid.PlatformStand = false end
        end
        RunService.Heartbeat:Wait()
    end
end)
