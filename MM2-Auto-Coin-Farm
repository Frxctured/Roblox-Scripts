local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")

-- CONFIGURATION
getgenv().coinFarm = getgenv().coinFarm or false 
local FLIGHT_SPEED = 60
local ROTATION_SPEED = 0.15

local bodyVelocity = nil
local bodyGyro = nil

--- ### 1. PERSISTENT GUI ### ---
local screenGui = player.PlayerGui:FindFirstChild("PersistentFarmGui")
if not screenGui then
	screenGui = Instance.new("ScreenGui")
	screenGui.Name = "PersistentFarmGui"
	screenGui.ResetOnSpawn = false -- This keeps the UI from disappearing on death
	screenGui.Parent = player.PlayerGui

	local btn = Instance.new("TextButton", screenGui)
	btn.Name = "ToggleBtn"
	btn.Size = UDim2.new(0, 150, 0, 50)
	btn.Position = UDim2.new(0.5, -75, 0.1, 0)
	btn.Text = "Noclip Farm: OFF"
	btn.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
	btn.TextColor3 = Color3.fromRGB(255, 255, 255)
	Instance.new("UICorner", btn)

	btn.MouseButton1Click:Connect(function()
		getgenv().coinFarm = not getgenv().coinFarm
		btn.Text = getgenv().coinFarm and "Noclip Farm: ON" or "Noclip Farm: OFF"
		btn.BackgroundColor3 = getgenv().coinFarm and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(170, 0, 0)
	end)
end

--- ### 2. CHARACTER REFRESH LOGIC ### ---
-- This function updates our variables whenever you respawn
local function onCharacterAdded(newChar)
	character = newChar
	hrp = character:WaitForChild("HumanoidRootPart")
	-- Reset physics references so they are recreated for the new body
	bodyVelocity = nil
	bodyGyro = nil
end

player.CharacterAdded:Connect(onCharacterAdded)

--- ### 3. THE NOCLIP LOOP ### ---
RunService.Stepped:Connect(function()
	if getgenv().coinFarm and character then
		for _, part in ipairs(character:GetDescendants()) do
			if part:IsA("BasePart") then
				part.CanCollide = false
			end
		end
	end
end)

--- ### 4. THE CORE ENGINE ### ---
local function getNearestCoin()
	local closestCoin = nil
	local shortestDistance = math.huge
	for _, child in ipairs(workspace:GetDescendants()) do
		if child:IsA("BasePart") and child.Name == "Coin_Server" then
			local distance = (child.Position - hrp.Position).Magnitude
			if distance < shortestDistance then
				shortestDistance = distance
				closestCoin = child
			end
		end
	end
	return closestCoin
end

task.spawn(function()
	while true do
		if getgenv().coinFarm and hrp then
			-- Ensure physics objects exist on the CURRENT character
			if not bodyVelocity or bodyVelocity.Parent ~= hrp then
				bodyVelocity = Instance.new("BodyVelocity")
				bodyVelocity.MaxForce = Vector3.new(1, 1, 1) * math.huge
				bodyVelocity.Parent = hrp
				
				bodyGyro = Instance.new("BodyGyro")
				bodyGyro.MaxTorque = Vector3.new(1, 1, 1) * math.huge
				bodyGyro.P = 3000
				bodyGyro.Parent = hrp
				character:WaitForChild("Humanoid").PlatformStand = true
			end

			local target = getNearestCoin()
			if target and target.Parent then
				local direction = (target.Position - hrp.Position).Unit
				local distance = (target.Position - hrp.Position).Magnitude
				
				if distance > 2 then
					bodyVelocity.Velocity = direction * FLIGHT_SPEED
					bodyGyro.CFrame = bodyGyro.CFrame:Lerp(CFrame.lookAt(hrp.Position, target.Position), ROTATION_SPEED)
				else
					bodyVelocity.Velocity = Vector3.zero
					task.wait(0.1)
				end
			else
				bodyVelocity.Velocity = Vector3.zero
			end
		elseif not getgenv().coinFarm and bodyVelocity then
			-- Cleanup when toggled off
			if bodyVelocity then bodyVelocity:Destroy() bodyVelocity = nil end
			if bodyGyro then bodyGyro:Destroy() bodyGyro = nil end
			if character:FindFirstChild("Humanoid") then character.Humanoid.PlatformStand = false end
		end
		task.wait()
	end
end)
