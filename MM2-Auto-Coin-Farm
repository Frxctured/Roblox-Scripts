local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")

-- CONFIGURATION
getgenv().coinFarm = getgenv().coinFarm or false 
local FLIGHT_SPEED = 75 -- Increased speed
local ROTATION_SPEED = 0.2 

local bodyVelocity = nil
local bodyGyro = nil
local lastCoin = nil -- To prevent getting stuck on the same coin

--- ### 1. PERSISTENT GUI ### ---
local screenGui = player.PlayerGui:FindFirstChild("PersistentFarmGui")
if not screenGui then
    screenGui = Instance.new("ScreenGui", player.PlayerGui)
    screenGui.Name = "PersistentFarmGui"
    screenGui.ResetOnSpawn = false

    local btn = Instance.new("TextButton", screenGui)
    btn.Size = UDim2.new(0, 150, 0, 50)
    btn.Position = UDim2.new(0.5, -75, 0.1, 0)
    btn.Text = "FAST Farm: OFF"
    btn.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    Instance.new("UICorner", btn)

    btn.MouseButton1Click:Connect(function()
        getgenv().coinFarm = not getgenv().coinFarm
        btn.Text = getgenv().coinFarm and "FAST Farm: ON" or "FAST Farm: OFF"
        btn.BackgroundColor3 = getgenv().coinFarm and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(170, 0, 0)
    end)
end

player.CharacterAdded:Connect(function(newChar)
    character = newChar
    hrp = character:WaitForChild("HumanoidRootPart")
end)

--- ### 2. THE NOCLIP ### ---
RunService.Stepped:Connect(function()
    if getgenv().coinFarm and character then
        for _, part in ipairs(character:GetDescendants()) do
            if part:IsA("BasePart") then part.CanCollide = false end
        end
    end
end)

--- ### 3. OPTIMIZED SEARCH ### ---
local function getNearestCoin()
    local closestCoin = nil
    local shortestDistance = math.huge
    
    -- Using GetChildren on a specific folder is faster if the game uses one
    -- But GetDescendants ensures we find everything
    for _, child in ipairs(workspace:GetDescendants()) do
        if child:IsA("BasePart") and child.Name == "Coin_Server" and child ~= lastCoin then
            local distance = (child.Position - hrp.Position).Magnitude
            if distance < shortestDistance then
                shortestDistance = distance
                closestCoin = child
            end
        end
    end
    return closestCoin
end

--- ### 4. THE SPEED LOOP ### ---
task.spawn(function()
    while true do
        if getgenv().coinFarm and hrp then
            -- Physics Check
            if not bodyVelocity or bodyVelocity.Parent ~= hrp then
                bodyVelocity = Instance.new("BodyVelocity", hrp)
                bodyVelocity.MaxForce = Vector3.new(9e9, 9e9, 9e9)
                bodyGyro = Instance.new("BodyGyro", hrp)
                bodyGyro.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
                character:WaitForChild("Humanoid").PlatformStand = true
            end

            local target = getNearestCoin()
            if target and target.Parent then
                local distance = (target.Position - hrp.Position).Magnitude
                
                if distance > 1 then
                    -- Movement
                    bodyVelocity.Velocity = (target.Position - hrp.Position).Unit * FLIGHT_SPEED
                    bodyGyro.CFrame = CFrame.lookAt(hrp.Position, target.Position)
                else
                    -- "Instant" pickup logic
                    bodyVelocity.Velocity = Vector3.zero
                    lastCoin = target -- Temporarily ignore this coin so we move to next
                    wait(0.5)
                end
            end
        else
            if bodyVelocity then 
                bodyVelocity:Destroy() bodyVelocity = nil 
                bodyGyro:Destroy() bodyGyro = nil 
                if character:FindFirstChild("Humanoid") then character.Humanoid.PlatformStand = false end
            end
        end
        RunService.Heartbeat:Wait() -- Runs as fast as the physics engine allows
    end
end)
