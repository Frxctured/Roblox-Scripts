local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")

-- CONFIGURATION
getgenv().coinFarm = getgenv().coinFarm or false 
local BASE_SPEED = 50
local MIN_WAIT = 0.4
local VELOCITY_THRESHOLD = 30
local RESET_CAP = 50 

local bodyVelocity = nil
local collectedCoins = {} 
local collectedCount = 0

--- ### 1. PERSISTENT GUI & INSPECTOR ### ---
local screenGui = player.PlayerGui:FindFirstChild("PersistentFarmGui")
if not screenGui then
    screenGui = Instance.new("ScreenGui", player.PlayerGui)
    screenGui.Name = "PersistentFarmGui"
    screenGui.ResetOnSpawn = false
    
    -- Main Toggle Button
    local btn = Instance.new("TextButton", screenGui)
    btn.Name = "ToggleBtn"
    btn.Size = UDim2.new(0, 180, 0, 50)
    btn.Position = UDim2.new(0.5, -90, 0.1, 0)
    btn.Text = "Farm: OFF (0/"..RESET_CAP..")"
    btn.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    Instance.new("UICorner", btn)

    btn.MouseButton1Click:Connect(function()
        getgenv().coinFarm = not getgenv().coinFarm
        btn.BackgroundColor3 = getgenv().coinFarm and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(170, 0, 0)
    end)

    -- UI Inspector Box (The temporary textbox)
    local inspector = Instance.new("ScrollingFrame", screenGui)
    inspector.Size = UDim2.new(0, 250, 0, 200)
    inspector.Position = UDim2.new(0, 10, 0.5, -100)
    inspector.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    inspector.BackgroundTransparency = 0.5
    
    local layout = Instance.new("UIListLayout", inspector)
    layout.Padding = UDim.new(0, 5)

    local title = Instance.new("TextLabel", screenGui)
    title.Size = UDim2.new(0, 250, 0, 20)
    title.Position = UDim2.new(0, 10, 0.5, -125)
    title.Text = "FOUND UI ELEMENTS:"
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.BackgroundTransparency = 1

    -- Scan for UI and show them in the box
    for _, v in pairs(player.PlayerGui:GetDescendants()) do
        if v:IsA("TextLabel") and (string.find(string.lower(v.Text), "coin") or tonumber(v.Text)) then
            local info = Instance.new("TextBox", inspector)
            info.Size = UDim2.new(1, -10, 0, 40)
            info.Text = v:GetFullName()
            info.TextWrapped = true
            info.ClearTextOnFocus = false
            info.TextSize = 10
            info.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
            info.TextColor3 = Color3.fromRGB(0, 255, 0)
        end
    end
end

local function updateGui()
    local btn = screenGui:FindFirstChild("ToggleBtn")
    if btn then
        btn.Text = (getgenv().coinFarm and "Farm: ON " or "Farm: OFF ").. "("..collectedCount.."/"..RESET_CAP..")"
    end
end

local function setupCharacter(newChar)
    character = newChar
    hrp = character:WaitForChild("HumanoidRootPart")
    collectedCount = 0 
    updateGui()
end
player.CharacterAdded:Connect(setupCharacter)

--- ### 2. THE NOCLIP ### ---
RunService.Stepped:Connect(function()
    if getgenv().coinFarm and character then
        for _, part in ipairs(character:GetDescendants()) do
            if part:IsA("BasePart") then part.CanCollide = false end
        end
    end
end)

--- ### 3. SEARCH LOGIC ### ---
local function getNearestCoin()
    local closestCoin = nil
    local shortestDistance = math.huge
    for _, child in ipairs(workspace:GetDescendants()) do
        if child:IsA("BasePart") and child.Name == "Coin_Server" and not collectedCoins[child] then
            local distance = (child.Position - hrp.Position).Magnitude
            if distance < shortestDistance then
                shortestDistance = distance
                closestCoin = child
            end
        end
    end
    return closestCoin
end

--- ### 4. ENGINE ### ---
task.spawn(function()
    while true do
        if getgenv().coinFarm and hrp then
            if collectedCount >= RESET_CAP then
                getgenv().coinFarm = false
                updateGui()
                if character:FindFirstChild("Humanoid") then character.Humanoid.Health = 0 end
                task.wait(5)
                getgenv().coinFarm = true 
                continue
            end

            if not bodyVelocity or bodyVelocity.Parent ~= hrp then
                bodyVelocity = Instance.new("BodyVelocity", hrp)
                bodyVelocity.MaxForce = Vector3.new(9e9, 9e9, 9e9)
                character:WaitForChild("Humanoid").PlatformStand = true
            end

            local target = getNearestCoin()
            if target and target.Parent then
                local distanceToNext = (target.Position - hrp.Position).Magnitude
                local adaptiveWait = math.clamp(distanceToNext / VELOCITY_THRESHOLD, MIN_WAIT, 3.5)
                
                bodyVelocity.Velocity = Vector3.zero
                task.wait(adaptiveWait)

                -- Fly to Target (Updated to 0.5 distance)
                while getgenv().coinFarm and target and target.Parent and (target.Position - hrp.Position).Magnitude > 0.5 do
                    bodyVelocity.Velocity = (target.Position - hrp.Position).Unit * BASE_SPEED
                    RunService.Heartbeat:Wait()
                end

                if getgenv().coinFarm then
                    bodyVelocity.Velocity = Vector3.zero
                    collectedCoins[target] = tick()
                    collectedCount = collectedCount + 1
                    updateGui()
                    task.wait(0.2)
                end
            else
                bodyVelocity.Velocity = Vector3.zero
            end
        else
            if bodyVelocity then 
                bodyVelocity:Destroy() bodyVelocity = nil 
                if character:FindFirstChild("Humanoid") then character.Humanoid.PlatformStand = false end
            end
        end
        RunService.Heartbeat:Wait()
    end
end)
