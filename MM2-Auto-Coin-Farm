local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")

-- CONFIGURATION
getgenv().coinFarm = getgenv().coinFarm or false 
local BASE_SPEED = 55
local MIN_WAIT = 0.2
local VELOCITY_THRESHOLD = 35
local COIN_TYPE_TO_FARM = "Coin"
local SAFETY_DISTANCE = 15 -- Radius to trigger hiding
local HIDE_DEPTH = -50    -- Underground depth for safety

-- REMOTES
local GameplayRemotes = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Gameplay")
local CoinCollectedEvent = GameplayRemotes:WaitForChild("CoinCollected")
local RoundStartEvent = GameplayRemotes:WaitForChild("RoundStart")
local RoundEndEvent = GameplayRemotes:WaitForChild("RoundEndFade")

local bodyVelocity = nil
local collectedCoins = {} 
local collectedCount = 0
local currentMax = 50 
local playerRoles = {}
local isHiding = false
local isInRound = false
local lastHrpPos = hrp.Position

--- ### 1. VISUALS (ESP) ### ---
local function applyHighlights()
    for name, data in pairs(playerRoles) do
        local targetPlayer = Players:FindFirstChild(name)
        if targetPlayer and targetPlayer.Character then
            local old = targetPlayer.Character:FindFirstChild("RoleHighlight")
            if old then old:Destroy() end

            local highlight = Instance.new("Highlight")
            highlight.Name = "RoleHighlight"
            highlight.Parent = targetPlayer.Character
            highlight.FillTransparency = 0.5
            highlight.OutlineTransparency = 0
            
            if data.Role == "Murderer" then
                highlight.FillColor = Color3.fromRGB(255, 0, 0)
            elseif data.Role == "Sheriff" or data.Role == "Hero" then
                highlight.FillColor = Color3.fromRGB(0, 0, 255)
            else
                highlight:Destroy()
            end
        end
    end
end

local function applyGunESP()
    local gun = workspace:FindFirstChild("GunDrop")
    if gun then
        local handle = gun:FindFirstChild("Handle") or gun:FindFirstChildWhichIsA("BasePart")
        if handle and not handle:FindFirstChild("GunHighlight") then
            local highlight = Instance.new("Highlight")
            highlight.Name = "GunHighlight"
            highlight.Parent = handle
            highlight.FillColor = Color3.fromRGB(255, 215, 0)
            highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        end
    end
end

local function clearHighlights()
    for _, p in pairs(Players:GetPlayers()) do
        if p.Character and p.Character:FindFirstChild("RoleHighlight") then
            p.Character.RoleHighlight:Destroy()
        end
    end
end

--- ### 2. SERVER SYNC ### ---
RoundStartEvent.OnClientEvent:Connect(function(timer, roles)
    playerRoles = roles
    applyHighlights()
    isInRound = true
    collectedCount = 0
    collectedCoins = {}
end)

RoundEndEvent.OnClientEvent:Connect(function()
    playerRoles = {}
    clearHighlights()
    isInRound = false
    isHiding = false
end)

CoinCollectedEvent.OnClientEvent:Connect(function(cointype, current, max)
    if cointype == COIN_TYPE_TO_FARM then
        collectedCount = tonumber(current)
        currentMax = tonumber(max)
        updateGui()
    end
end)

local function getMurderer()
    for name, data in pairs(playerRoles) do
        if data.Role == "Murderer" then
            local mPlr = Players:FindFirstChild(name)
            if mPlr and mPlr.Character and mPlr.Character:FindFirstChild("HumanoidRootPart") then
                return mPlr.Character.HumanoidRootPart
            end
        end
    end
    return nil
end

--- ### 3. GUI & CHARACTER SETUP ### ---
local screenGui = player.PlayerGui:FindFirstChild("PersistentFarmGui")
if not screenGui then
    screenGui = Instance.new("ScreenGui", player.PlayerGui)
    screenGui.Name = "PersistentFarmGui"
    screenGui.ResetOnSpawn = false
    local btn = Instance.new("TextButton", screenGui)
    btn.Name = "ToggleBtn"
    btn.Size = UDim2.new(0, 200, 0, 50)
    btn.Position = UDim2.new(0.5, -100, 0.1, 0)
    btn.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    Instance.new("UICorner", btn)
    btn.MouseButton1Click:Connect(function()
        getgenv().coinFarm = not getgenv().coinFarm
        btn.BackgroundColor3 = getgenv().coinFarm and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(170, 0, 0)
        updateGui()
    end)
end

function updateGui()
    local btn = screenGui:FindFirstChild("ToggleBtn")
    if btn then
        local status = isHiding and "HIDING" or (getgenv().coinFarm and "ON" or "OFF")
        btn.Text = "Farm: " .. status .. " (" .. collectedCount .. "/" .. currentMax .. ")"
    end
end

player.CharacterAdded:Connect(function(newChar)
    character = newChar
    hrp = character:WaitForChild("HumanoidRootPart")
    collectedCount = 0
    updateGui()
end)

RunService.Stepped:Connect(function()
    if getgenv().coinFarm and character then
        for _, part in ipairs(character:GetDescendants()) do
            if part:IsA("BasePart") then part.CanCollide = false end
        end
    end
end)

--- ### 4. ENGINE ### ---
local function getNearestCoin()
    local closestCoin = nil
    local shortestDistance = math.huge
    for _, child in ipairs(workspace:GetDescendants()) do
        if child:IsA("BasePart") and child.Name == "Coin_Server" and not collectedCoins[child] then
            local distance = (child.Position - hrp.Position).Magnitude
            if distance < shortestDistance then
                shortestDistance = distance
                closestCoin = child
            end
        end
    end
    return closestCoin
end

task.spawn(function()
    while true do
        if getgenv().coinFarm and isInRound and hrp then
            applyGunESP()
            
            local murdererHRP = getMurderer()
            local distToMurd = murdererHRP and (murdererHRP.Position - hrp.Position).Magnitude or math.huge

            -- STEALTH LOGIC
            if distToMurd < SAFETY_DISTANCE then
                if not isHiding then
                    lastHrpPos = hrp.Position
                    isHiding = true
                    updateGui()
                end
                bodyVelocity.Velocity = Vector3.zero
                hrp.CFrame = CFrame.new(hrp.Position.X, HIDE_DEPTH, hrp.Position.Z)
                task.wait(0.5)
                continue
            else
                if isHiding then
                    isHiding = false
                    hrp.CFrame = CFrame.new(hrp.Position.X, lastHrpPos.Y, hrp.Position.Z)
                    updateGui()
                end
            end

            -- AUTO-RESET
            if collectedCount >= currentMax and currentMax > 0 then
                collectedCount = 0
                updateGui()
                if character:FindFirstChild("Humanoid") then character.Humanoid.Health = 0 end
                isInRound = false
                task.wait(5)
                continue
            end

            -- PHYSICS SETUP
            if not bodyVelocity or bodyVelocity.Parent ~= hrp then
                bodyVelocity = Instance.new("BodyVelocity", hrp)
                bodyVelocity.MaxForce = Vector3.new(9e9, 9e9, 9e9)
                character:WaitForChild("Humanoid").PlatformStand = true
            end

            -- MOVEMENT
            local target = getNearestCoin()
            if target and target.Parent then
                local distance = (target.Position - hrp.Position).Magnitude
                local adaptiveWait = math.clamp(distance / VELOCITY_THRESHOLD, MIN_WAIT, 3)
                
                bodyVelocity.Velocity = Vector3.zero
                task.wait(adaptiveWait)

                while getgenv().coinFarm and target and target.Parent and (target.Position - hrp.Position).Magnitude > 0.5 do
                    local m = getMurderer()
                    if m and (m.Position - hrp.Position).Magnitude < SAFETY_DISTANCE then break end
                    
                    bodyVelocity.Velocity = (target.Position - hrp.Position).Unit * BASE_SPEED
                    RunService.Heartbeat:Wait()
                end

                if getgenv().coinFarm then
                    bodyVelocity.Velocity = Vector3.zero
                    collectedCoins[target] = tick()
                    task.wait()
                end
            end
        else
            if bodyVelocity then bodyVelocity:Destroy() bodyVelocity = nil end
        end
        RunService.Heartbeat:Wait()
    end
end)
